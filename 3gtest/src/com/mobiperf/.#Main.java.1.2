/****************************
 * This file is part of the MobiPerf project (http://mobiperf.com). 
 * We make it open source to help the research community share our efforts.
 * If you want to use all or part of this project, please give us credit and cite MobiPerf's official website (mobiperf.com).
 * The package is distributed under license GPLv3.
 * If you have any feedbacks or suggestions, don't hesitate to send us emails (3gtest@umich.edu).
 * The server suite source code is not included in this package, if you have specific questions related with servers, please also send us emails
 * 
 * Contact: 3gtest@umich.edu
 * Development Team: Junxian Huang, Birjodh Tiwana, Zhaoguang Wang, Zhiyun Qian, Cheng Chen, Yutong Pei, Feng Qian, Qiang Xu
 * Copyright: RobustNet Research Group led by Professor Z. Morley Mao, (Department of EECS, University of Michigan, Ann Arbor) and Microsoft Research
 *
 ****************************/

package com.mobiperf;
import java.util.ArrayList;

import android.app.Activity;
import android.app.AlarmManager;
import android.app.AlertDialog;
import android.app.Dialog;
import android.app.Notification;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.content.ActivityNotFoundException;
import android.content.ComponentName;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.ServiceConnection;
import android.os.Bundle;
import android.os.Handler;
import android.os.IBinder;
import android.util.Log;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.ListView;
import android.widget.ProgressBar;
import android.widget.TextView;
import android.widget.Toast;



public class Main extends Activity {
	 
    TextView t1, t2, t3;
    //--------------------cc
    String test;
    static boolean stopFlag = false;
    ProgressBar mProgress;
    public ListView listView; 
    ArrayAdapter<String> adapter;
    Button button;
    //Button button1,button2;
    Button button_tab_view;
	// Need handler for callbacks to the UI thread
    static Handler mHandler = new Handler();
    

    public void onStart() {
    	
    	Log.w("MobiPerf", "threegtest start begin");
    	
    	super.onStart();
    	
    	InformationCenter.init(this);
    	
    	doBindService();
    	
    	//TODO Move GPS into InformationCenter
    	GPS.location(this);
    	
    	stopFlag = false;
    	//start = System.currentTimeMillis();
    	
        // Show first time run warning
        firstTimeRun();
        
        
        
    	// Setup periodical run
    	if(isAllowedPeriodicalRun(this))
    		enablePeriodicalRun(this);
        //long install = System.currentTimeMillis() - start;
        //toastMessage("install "+ install);
    }
    
    @Override
    protected void onDestroy() {
        super.onDestroy();
        doUnbindService();
        Log.v("MobiPerf", "threegtest onDestroy");
    }

    @Override
    public void onCreate( Bundle savedInstanceState ) {
    	long start = System.currentTimeMillis();
    	Log.v("MobiPerf", "threegtest create begins");
        
    	super.onCreate( savedInstanceState );
    	
        //create user interface
        setContentView( R.layout.main1 );
    	
        button = ( Button ) findViewById( R.id.Button01 );
        //TODO: button added to be test----cc
        button_tab_view = ( Button ) findViewById( R.id.button_tab_view );
        //button2 = ( Button ) findViewById( R.id.button2 );
        t1 = ( TextView ) findViewById( R.id.textview1 );
        t2 = ( TextView ) findViewById( R.id.textview2 );
        t3 = ( TextView ) findViewById( R.id.textview3 );
        mProgress = ( ProgressBar ) findViewById( R.id.progress_bar );

        t1.setHintTextColor( 2 );
        t2.setHintTextColor( 2 );
        t3.setHintTextColor( 2 );
        
        updateProgress(0);
        
        listView = ( ListView ) findViewById( R.id.list );
        //adapter = new ArrayAdapter<String>( this, R.layout.simple_list_item_1 );
        //play around with listview - mhayter
        //listView.setAdapter( adapter );
        //adapter.setNotifyOnChange(false);
        
        updateUI();

        button.setOnClickListener( 
        		new View.OnClickListener() {
                   public void onClick( final View view ) {
                       //Utilities.checkifrunning(context);

                       if (isRunning())	// Stop service 
                       {
                    	   stopFlag = true;
                           updateTextView3("The program is trying to stop...");
                           updateButton("Please wait");
                           button.setClickable(false);
                       }
                       else {
                    	   stopFlag=false;
                    	   updateTextView3("Starting tests...");
                           updateButton("Please wait");
                           button.setClickable(false);
                           
                    	   updateProgress(0); // clear progress
                    	   updateListView(new ArrayList<String>());// empty listview
                       	   Intent svc = new Intent(getApplicationContext(), MainService.class);
                           svc.setAction("run");
                           startService(svc);	//Start Service_Thread
                       }
                   }
               }
        	);
        
        //TODO:Switch views to a tabhost view--------CC
        button_tab_view.setOnClickListener(
        		new View.OnClickListener() {
        			 public void onClick( final View view ) {
        				// setContentView( R.layout.display1);
        				 //Intent i = new Intent(view.getContext(), com.mobiperf.ui.Display.class);
        				 //startActivityForResult(i, 0);
        				 
        				 Tcpdump.start();
        			 }
        		}
        );
        button_tab_view.setText("More Details");
        
        

        //displayResult("abc","a ","daadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsf",0);
        //displayResult("abc","a ","daadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsf",0);
        //displayResult("abc","a ","daadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsf",1);
        //displayResult("abc","a ","daadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsf",2);
        //displayResult("abc","a ","daadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsfdaadfsdfsf",2);
               
        /*button2.setOnClickListener(
        		new View.OnClickListener() {
        			 public void onClick( final View view ) {
        				 //setContentView( R.layout.display1);
        				 //Intent i = new Intent(view.getContext(), eecs.umich.threegtest.ui.Display.class);
        				 //startActivityForResult(i, 0);
        				 //temp
        				 
        				 Intent settingsActivity = new Intent(view.getContext(), com.mobiperf.ui.Preferences.class);
        				 startActivityForResult(settingsActivity, 0);
        			 }
        		}
        );
        */


       Log.v("MobiPerf", "create finish in "+ (System.currentTimeMillis() - start));
    }

	/****** methods for updating UI ******/
    public void updateTextView1(final String text)
    {
    	mHandler.post(new Runnable() {
            public void run() {
            	t1.setText(text);
            }
        });
    }
    // update progress bar
    public void updateProgress(final int val)
    {
    	mHandler.post(new Runnable() {
            public void run() {
            	mProgress.setProgress(val);
            	t2.setText(val+"% complete");
            }
        });
    }
    public void updateTextView2(final String text)
    {
    	mHandler.post(new Runnable() {
            public void run() {
            	t2.setText(text);
            }
        });
    }
    public void updateTextView3(final String text)
    {
    	mHandler.post(new Runnable() {
            public void run() {
            	t3.setText(text);
            }
        });
    }
    public void updateButton(final String text)
    {
    	mHandler.post(new Runnable() {
            public void run() {
            	button.setText(text);
            }
        });
    }
    // update result list
    public void updateListView(final ArrayList<String> list)
    { 	
    	mHandler.post(new Runnable() {
            public void run() {
            	listView.setVisibility(View.GONE);           	
            	adapter = new ArrayAdapter<String>(getApplicationContext(), R.layout.simple_list_item_1, list);
            	//adapter.setNotifyOnChange(false);
            	listView.setAdapter(adapter);
            	listView.setVisibility(View.VISIBLE);
            }
        });
    }
    // update button and tv3 based on isRunning();
    public void updateUI()
    {
    	if( isRunning() == false) 
    	{
            updateButton("Run");
            button.setClickable(true);
            updateTextView3(Feedback.getMessage(Feedback.TYPE.NEW_TEST, null));
            updateTextView1("Please allow 2~3 minutes to finish all the tests.");
    	}else
        {
        	button.setClickable(true);
            updateButton( "Stop" );
        	updateTextView3("Tests are running.");
            updateTextView1("You may switch back to check results later.");
            //clear 3 tab contents
            clearTabView();
        }
    }
    /*************************************************/

/******************** Menu starts here by Gary ********************/
    // Define menu ids
	protected static final int MENU_PERIODIC = Menu.FIRST;
	//protected static final int MENU_NOTIFICATION = Menu.FIRST + 1;
	//-------------commented by cc---------
	//protected static final int MENU_LAST = Menu.FIRST + 2;
	//protected static final int MENU_HISTORY = Menu.FIRST + 3;
	protected static final int MENU_EMAIL = Menu.FIRST +4;
	//TODO:new menu --------cc
	protected static final int PAST_RECORD = Menu.FIRST +5;
	// Create menu
	@Override
	public boolean onCreateOptionsMenu(Menu menu) {
	        super.onCreateOptionsMenu(menu);
	        menu.add(0, MENU_PERIODIC, 0, "Settings");
	       // menu.add(0, MENU_NOTIFICATION, 0, "Notification setting").setEnabled(isPeriodicalRunEnabled(this)?true:false);
	        //menu.add(0, MENU_LAST, 0, "Last run results");
	        //menu.add(0, MENU_HISTORY, 0, "Periodic run results");
	      //TODO:new menu --------cc
	        menu.add(0, PAST_RECORD, 0, "View past record");
	        menu.add(0, MENU_EMAIL, 0, "About us");

	        return true;
	}
	@Override
	public boolean onPrepareOptionsMenu(Menu menu)
	{
		
		Log.v("LOG","menu prepare");
		//menu.findItem(MENU_NOTIFICATION).setEnabled(isPeriodicalRunEnabled(this)?true:false);
		return true;
	}
	
	// Deal with menu event
	@Override
	public boolean onOptionsItemSelected(MenuItem item) {
	        super.onOptionsItemSelected(item);
	        Log.v("menu","onOptionsItemSelected "+item.getItemId());
	        switch (item.getItemId()) {
	        case MENU_PERIODIC:
	        	 	Log.v("menu", "DIALOG_PERIODIC");
	        	 	// Show the setting dialog for periodical running
	        	 	//showDialog(DIALOG_PERIODIC);
	        	 	Intent settingsActivity = new Intent(this, com.mobiperf.ui.Preferences.class);
	        	 	startActivityForResult(settingsActivity, 0);
	        	 	
	                break;
	       /* case MENU_NOTIFICATION:
        	 	Log.v("menu", "DIALOG_NOTIFICATION");
        	 	// Show the setting dialog for periodical running
        	 	showDialog(DIALOG_NOTIFICATION);
                break;
                */
           //--------------commented by cc------------
	        /*case MENU_LAST:
	        	try {
					this.getApplicationContext().openFileInput(Service_Thread.LAST_LOG_FILE_NAME);
					this.startActivity(new Intent(this,LastRunResult.class));
				} catch (FileNotFoundException e1) {
					this.toastMessage("Last run results were not found\nPlease run the tests");
					e1.printStackTrace();
				}
                break;
	        case MENU_HISTORY:
        	 	Log.v("menu", "HISTORY");
        	 	// Show the setting dialog for periodical running
        	 	this.startActivity(new Intent(this,History.class));
                break;
                */
            //TODO:new menu --------cc
	        case PAST_RECORD:
	        	 Intent i = new Intent(this, com.mobiperf.ui.HistoricalList.class);
				 startActivityForResult(i, 0);
				 break;
	        case MENU_EMAIL:
	        	try
	        	{
	        		//--------commented by cc -----------
					/*Intent emailIntent = new Intent(
							android.content.Intent.ACTION_SEND);
	
					String aEmailList[] = { "MobiPerf@umich.edu" };
					// String aEmailCCList[] = {
					// "user3@fakehost.com","user4@fakehost.com"};
					// String aEmailBCCList[] = { "user5@fakehost.com" };
					emailIntent.putExtra(android.content.Intent.EXTRA_EMAIL,
							aEmailList);
					// emailIntent.putExtra(android.content.Intent.EXTRA_CC,
					// aEmailCCList);
					// emailIntent.putExtra(android.content.Intent.EXTRA_BCC,
					// aEmailBCCList);
					emailIntent.putExtra(android.content.Intent.EXTRA_SUBJECT,
							"Feedback on MobiPerf");
					emailIntent.setType("plain/text");
					// emailIntent.putExtra(android.content.Intent.EXTRA_TEXT,
					// "My message body.");
					startActivity(emailIntent);
					*/
	        		
	        		 Intent in1 = new Intent(this, com.mobiperf.ui.About.class);
					 startActivityForResult(in1, 0);
	        	}
	        	catch(ActivityNotFoundException e)
	        	{
	        		Toast.makeText(getApplicationContext(), "Please send us an email at MobiPerf@umich.edu", Toast.LENGTH_SHORT).show();
	        	}
	        	break;
	        }
	        

	        return true;

	}
	// Define dialog ids
	protected static final int DIALOG_PERIODIC = 0;
	protected static final int DIALOG_WARNING = 1;
	protected static final int DIALOG_NOTIFICATION = 2;
	protected static final String WARNING = 
		"NAT and firewall tests require root access to open raw socket. " 
		+"Other tests still run normally if your phone is not rooted.\n\n"
		+"A very lightweight test is run periodically every hour by default, giving two benefits:\n"
		+"(1) better diagnose your network (we provide you with history of your network performance),\n"
		+"(2) enables our research for long-term network improvement.\n\n"
		+"We provide the setting to opt out, but we do appreciate you keep this option enabled.\n"
		+"Thank you for your help!";
	// Options for periodical running
	public static final int PERIODIC_YES = 0;
	public static final int PERIODIC_NO = 1;
	final CharSequence[] periodicItems = {"Yes","No"};
	final CharSequence[] periodicPrompts = {"Periodic running is enabled", "Periodical running is disabled"};
	public static final int NOTIFICATION_YES = 0;
	public static final int NOTIFICATION_NO = 1;
	final CharSequence[] notificationItems = {"Yes","No"};
	final CharSequence[] notificationPrompts = {"Notification is enabled", "Notification is disabled"};
	protected Dialog onCreateDialog(int id) {
	    Dialog dialog;
	    AlertDialog.Builder builder;
	    switch(id) {
	    case DIALOG_PERIODIC:
	    	builder = new AlertDialog.Builder(this);
	    	builder.setTitle("Enable lightweight tests running every hour");
	    	builder.setSingleChoiceItems(periodicItems, isPeriodicalRunEnabled(this)?0:1, new DialogInterface.OnClickListener() {
	    	    public void onClick(DialogInterface dialog, int item) {
	    	        switch(item)
	    	        {
	    	        case PERIODIC_YES:
	    	        	enablePeriodicalRun(Main.this);
	    	        	break;
	    	        case PERIODIC_NO:
	    	        	disablePeriodicalRun();
	    	        	break;
	    	        default:
	    	        }
	    	        Toast.makeText(getApplicationContext(), periodicPrompts[item], Toast.LENGTH_SHORT).show();
	    	        Main.this.dismissDialog(DIALOG_PERIODIC);
	    	    }
	    	});
	    	dialog = builder.create();
	    	break;
	    case DIALOG_NOTIFICATION:
	    	builder = new AlertDialog.Builder(this);
	    	builder.setTitle("Enable notification");
	    	builder.setSingleChoiceItems(notificationItems, isNotificationEnabled?0:1, new DialogInterface.OnClickListener() {
	    	    public void onClick(DialogInterface dialog, int item) {
	    	        switch(item)
	    	        {
	    	        case NOTIFICATION_YES:
	    	        	isNotificationEnabled = true;
	    	        	if(isPeriodicalRunEnabled(Main.this))
	    	        		Main.createNotification(Main.this);
	    	        	break;
	    	        case NOTIFICATION_NO:
	    	        	Main.this.clearNotification();
	    	        	isNotificationEnabled = false;
	    	        	break;
	    	        default:
	    	        }
	    	        Toast.makeText(getApplicationContext(), notificationPrompts[item], Toast.LENGTH_SHORT).show();
	    	        Main.this.dismissDialog(DIALOG_NOTIFICATION);
	    	    }
	    	});
	    	dialog = builder.create();
	    	break;
	    case DIALOG_WARNING:
	    	builder = new AlertDialog.Builder(this);
			builder.setTitle("Notice")
				   .setMessage(WARNING)
			       .setCancelable(false)
			       .setPositiveButton("OK", new DialogInterface.OnClickListener() {
			           public void onClick(DialogInterface dialog, int id) {
			        	   Main.this.dismissDialog(DIALOG_WARNING);
			           }
			       });
			dialog = builder.create();
	    	break;
	    default:
	        dialog = null;
	    }
	    return dialog;
	}
	

/******************** Menu ends here ********************/

	/*
    long repeattime;
    @Override
    public boolean onCreateOptionsMenu( Menu menu ) {
        super.onCreateOptionsMenu( menu );
        //menu.add(0, 0, 0,"No repeatitions");
        //menu.add(0, 1, 0,"Repeat every 10 minutes");
        //menu.add(0, 2, 0,"Repeat every 1 hour");
        //menu.add(0, 3, 0,"Repeat every 6 hour");
        //menu.add(0, 4, 0,"Repeat every 12 hour");
        //menu.add(0, 5, 0,"Repeat every 24 hours");
        return true;
    }

    @Override
    public boolean onOptionsItemSelected( MenuItem item ) {
        super.onOptionsItemSelected( item );

        switch ( item.getItemId() ) {
        case 0:
            repeattime = 0;
            break;
        case 1:
            repeattime = 600000;
            break;
        case 2:
            repeattime = 3600000;
            break;
        case 3:
            repeattime = 21600000;
            break;
        case 4:
            repeattime = 43200000;
            break;
        case 5:
            repeattime = 86400000;
            break;
        default:
            break;
        }

        Utilities.checkifrunning(context);
        Utilities.write_to_file("repeatfile.txt", MODE_WORLD_READABLE,"" + repeattime + "\n", context );
        Utilities.checkifrunning(context);

        if ( isRunning ) {
            mHandler.post( new Runnable() {
                               public void run() {
                                   t3.setPadding( 40, 5, 10, 5 );
                                   t3.setText( "App is running, press button to stop" );
                               }
                           }

                         );
        }
        return false;
    }
    */
	/*************** Create warning by Gary ************************/ 
	// Only run once
	private void firstTimeRun(){
    	String FILENAME = "first_time_mark_1.4";
    	String  mark = "1";
		String[] fileList = fileList();
		for(int i = 0; i<fileList.length; i++)
			if(fileList[i].equals(FILENAME))
				// Already shown up
				return;
		// The following codes will only be called once after the app. is installed
		Utilities.writeToFile(FILENAME, Context.MODE_PRIVATE, mark,this);
		// Show warning
    	showDialog(DIALOG_WARNING);
    	// Remove existing pending intent after update a new version app.
    	disablePeriodicalRun();
    	enablePeriodicalRun(this);
    }
	
    /*************** Create notification by Gary ***********************/
	public  static final int NOTIFICATION_ID = 0;
	private static boolean isNotificationEnabled = true; // Show notification by default
    public static void createNotification(Context context){
		 NotificationManager mNotificationManager = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);
		  //2. Instantiate the Notification:
	      int icon = R.drawable.iconstat;
	      CharSequence tickerText = "MobiPerf";
	      long when = System.currentTimeMillis();
	      Notification notification = new Notification(icon, tickerText, when);
	      notification.defaults |= Notification.FLAG_NO_CLEAR;	// Never get cleared
	      notification.flags |= Notification.FLAG_NO_CLEAR;	// Never get cleared
	      // 3. Define the Notification's expanded message and Intent:
	      CharSequence contentTitle = "MobiPerf";
	      CharSequence contentText = "Lightweight test is running every hour.";
	      Intent notificationIntent = new Intent(context, History.class);
	      PendingIntent contentIntent = PendingIntent.getActivity(context, 0, notificationIntent, 0);
	      notification.setLatestEventInfo(context, contentTitle, contentText, contentIntent);
	      // 4. Pass the Notification to the NotificationManager:
	      mNotificationManager.notify(Main.NOTIFICATION_ID, notification);
	}
    
	private void clearNotification(){
		NotificationManager mNotificationManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);
		mNotificationManager.cancel(NOTIFICATION_ID);
	}

	/******** print something on screen for debugging purpose by Gary ***********/
	private static void debug(Context context, String p){
		Toast.makeText(context, p, Toast.LENGTH_SHORT).show();
	}
	
	public void toastMessage(String s){
    	Toast toast = Toast.makeText(this.getApplicationContext(), s, 2);
    	toast.show();
    }
	
	/**** Functions for periodical running by Gary ****/
    public static boolean isAllowedPeriodicalRun(Context context){
    	String r = Utilities.read_first_line_from_file(Definition.PERIODIC_FILE, Context.MODE_PRIVATE, context);
    	if(r != null && r.equals(PERIODIC_NO + ""))
    		return false;
    	return true;
    }
	public static void enablePeriodicalRun(Context context){
        //Log.v("LOG", "registering intent with periodc class");
        Intent intent = new Intent(context, Periodic.class);
    	PendingIntent pendingIntent = PendingIntent.getBroadcast(context, Definition.PERIODIC_REQUEST_CODE, intent, PendingIntent.FLAG_NO_CREATE);
    	//Log.v("LOG", "PendingIntent.getBroadcast() returns " + pendingIntent);
    	if(pendingIntent != null){
    		//debug(context, "Alarm already registerd");
    	}else{
    		//debug(context, "Register new alarm");
    		// Create new pending intent
    		pendingIntent = PendingIntent.getBroadcast(context, Definition.PERIODIC_REQUEST_CODE, intent, 0);
    		AlarmManager alarmManager = (AlarmManager) context.getSystemService(ALARM_SERVICE);
    		// First run starts 1 mins later after registering

        	alarmManager.setRepeating(AlarmManager.RTC_WAKEUP, 
        			System.currentTimeMillis() + Definition.PERIODIC_FIRST_RUN_STARTING_DELAY, 
        			Definition.PERIODIC_INTERVAL, pendingIntent);
    	}

    	Utilities.writeToFile(Definition.PERIODIC_FILE, Context.MODE_PRIVATE, PERIODIC_YES + "", context);
    	if(isNotificationEnabled)
    		createNotification(context);
	}
	/**** By Gary ****/
	private void disablePeriodicalRun(){
        //Log.v("LOG", "registering intent with periodic class");
        Intent intent = new Intent(this, Periodic.class);
    	PendingIntent pendingIntent = PendingIntent.getBroadcast(this, Definition.PERIODIC_REQUEST_CODE, intent, PendingIntent.FLAG_NO_CREATE);
    	//Log.v("LOG", "PendingIntent.getBroadcast() returns " + pendingIntent);
    	if(pendingIntent != null){
    		//debug("Alarm cancelled");
    		AlarmManager alarmManager = (AlarmManager) getSystemService(ALARM_SERVICE);
    		// Cancel alarm
    		alarmManager.cancel(pendingIntent);
    		// Remove the pending intent
    		pendingIntent.cancel();
    	}

    	Utilities.writeToFile(Definition.PERIODIC_FILE, Context.MODE_PRIVATE, PERIODIC_NO + "", this);

    	clearNotification();
	}
	/****** By Gary *******/
	public static boolean isPeriodicalRunEnabled(Context context)
	{
		Intent intent = new Intent(context, Periodic.class);
    	PendingIntent pendingIntent = PendingIntent.getBroadcast(context, Definition.PERIODIC_REQUEST_CODE, intent, PendingIntent.FLAG_NO_CREATE);
    	//Log.v("LOG", "PendingIntent.getBroadcast() returns " + pendingIntent);
    	if(pendingIntent == null)
    	{
    		return false;
    	}
    	return true;
	}
	
    
    /********** methods for binding to ThreegtestService ************/
    private MainService mBoundService;
    private boolean mIsBound = false;

    private ServiceConnection mConnection = new ServiceConnection() {
    	//@Override
        public void onServiceConnected(ComponentName className, IBinder service) {
            
            mBoundService = ((MainService.Threegtest_Binder)service).getService();
            mBoundService.setActivity(Main.this);
            updateUI();
            // If service thread is running, update UI
            if(mBoundService.testThread!=null && mBoundService.testThread.isAlive())
            {
            	updateListView(mBoundService.resultList);
            	updateProgress(mBoundService.testThread.mProgressStatus);
            	updateTextView3(mBoundService.currentTest);
            }
            //mBoundService.bindThreadActivity(threegtest.this);
            // Tell the user about this for our demo.
            //Toast.makeText(getApplicationContext(), "service connected",
            //        Toast.LENGTH_SHORT).show();
            Log.v("MobiPerf", "service connected");
        }
    	//@Override
        public void onServiceDisconnected(ComponentName className) {
           
            mBoundService = null;
            //Toast.makeText(getApplicationContext(), "service disconnected",
            //        Toast.LENGTH_SHORT).show();
            Log.v("MobiPerf", "service disconnected");
        }

    };

    private void doBindService() {
        
        bindService(new Intent(getApplicationContext(), MainService.class), mConnection, Context.BIND_AUTO_CREATE);
        mIsBound = true;
    }
 
    private void doUnbindService() {
        if (mIsBound) {
            // Detach our existing connection.
            unbindService(mConnection);
            mIsBound = false;
        }
    }
    /**********************************************************/
    
    // check if the there is a Service_Thread instance running
    public boolean isRunning()
    {
        if(mBoundService != null){	// Service already started
        	if(mBoundService.testThread != null && mBoundService.testThread.isAlive())
        		return true;
        	else
        		return false;
        }else{
        	Log.v("MobiPerf", "mBoundService null not running");
        	return false;
        }
    }
    
    //interface for the tabview---------------cc
	public static ArrayList<String> titles_basic = new ArrayList<String>();
	public static ArrayList<String> description_basic = new ArrayList<String>();
	public static ArrayList<String> result_basic = new ArrayList<String>();
	
	public static ArrayList<String> titles_performance = new ArrayList<String>();
	public static ArrayList<String> description_performance = new ArrayList<String>();
	public static ArrayList<String> result_performance = new ArrayList<String>();
	
	public static ArrayList<String> titles_policy = new ArrayList<String>();
	public static ArrayList<String> description_policy = new ArrayList<String>();
	public static ArrayList<String> result_policy = new ArrayList<String>();
    
	/**
	 * 
	 * @param title
	 * @param description
	 * @param result
	 * @param tab 0: basic, 1: performance, 2: policy
	 */
	public static void displayResult(String title, String description, String result, int tab){
		if(tab == 0){
			titles_basic.add(title);
			description_basic.add(description);
			result_basic.add(result);
		}
		else if (tab == 1){
			titles_performance.add(title);
			description_performance.add(description);
			result_performance.add(result);
			
		}
		else if(tab == 2){
			titles_policy.add(title);
			description_policy.add(description);
			result_policy.add(result);
		}
	}
	
	public static void clearTabView(){
		titles_basic = new ArrayList<String>();
    	description_basic = new ArrayList<String>();
    	result_basic = new ArrayList<String>();
    	
        titles_performance = new ArrayList<String>();
    	description_performance = new ArrayList<String>();
    	result_performance = new ArrayList<String>();
    	
    	titles_policy = new ArrayList<String>();
    	description_policy = new ArrayList<String>();
    	result_policy = new ArrayList<String>();
	}
    
}